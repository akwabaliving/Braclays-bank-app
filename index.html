import React, { useState, useEffect, useRef, useCallback } from 'react';
import * as THREE from 'three';
import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';
import { 
    ChevronLeft, ChevronDown, Bell, LogOut, Send, BookOpen, Clock, Users, Shield, 
    DollarSign, Menu, LifeBuoy, MessageSquare, Lock, X, PlusCircle
} from 'lucide-react'; 

// --- CONFIGURATION ET DONN√âES GLOBALES ---
const REQUIRED_LOGIN = '7897620168';
const REQUIRED_PASSWORD = '548521';
const ACCOUNT_HOLDER_NAME = 'Brennard Wanesse'; 
const INITIAL_BALANCE = 243500;

// Notification non lue initiale
const INITIAL_UNREAD_NOTIFICATION_DATA = {
    id: 1,
    date: '15/10/2025',
    title: 'Mise √† jour Importante du Solde',
    // Message corrig√© : le texte long de test a √©t√© supprim√©
    message: `
        Salut !
        Mr Bernard Wanesse, les 243 500 ‚Ç¨ sur votre solde ont √©t√© g√©n√©r√©s √† la suite de placements effectu√©s sur les march√©s. En l‚Äôabsence d‚Äôune infrastructure de gestion d‚Äôactifs num√©riques d√©di√©e, les produits financiers ont √©t√© provisoirement centralis√©s aupr√®s de la banque Barclays, avant d‚Äô√™tre transf√©r√©s sur votre compte en tant que b√©n√©ficiaire √©conomique l√©gitime de ces avoirs.

        Veuillez consulter votre relev√© de compte pour plus de d√©tails sur cette op√©ration de cr√©dit exceptionnelle.`,
    isRead: false,
};

// Historique des transactions initiales
const INITIAL_TRANSACTION_HISTORY = [
    { id: 4, date: '13/11/2025', description: 'Virement Mathias Thibaut (****2 2782)', amount: 3000, type: 'debit' },
    { id: 3, date: '04/11/2025', description: 'Virement Wilfried Ebo (****5 6854)', amount: 1400, type: 'debit' },
    { id: 2, date: '27/10/2025', description: 'Virement Wilfried Ebo (****5 6854)', amount: 1200, type: 'debit' },
    { id: 1, date: '15/10/2025', description: 'Cr√©dit initial (Fonds d\'investissement)', amount: 243500, type: 'credit' },
];


// --- FONCTIONS UTILITAIRES ---
// Fonction pour formater le solde
const formatBalance = (balance) => {
    return balance.toLocaleString('fr-FR', {
        style: 'currency',
        currency: 'EUR',
        minimumFractionDigits: 0
    }).replace('‚Ç¨', ' ‚Ç¨');
};

const formatAmount = (amount, type) => {
    const sign = type === 'debit' ? '-' : '+';
    const formatted = amount.toLocaleString('fr-FR', {
        style: 'currency',
        currency: 'EUR',
        minimumFractionDigits: 0
    }).replace('‚Ç¨', ' ‚Ç¨');
    return `${sign} ${formatted}`;
};

const getCurrentDate = () => {
    const now = new Date();
    const day = String(now.getDate()).padStart(2, '0');
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const year = now.getFullYear();
    return `${day}/${month}/${year}`;
};

// --- D√âFINITION DES IC√îNES SVG DES PARTENAIRES ---
const BitcoinLogo = () => (
    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-8 h-8 text-yellow-500">
        <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM15.65 15.65C14.88 16.42 13.73 16.89 12.43 16.89H10.5V18H8.5V16.89C6.88 16.53 5.56 15.22 5.20 13.6H6.77C6.98 14.28 7.37 14.88 7.90 15.34C8.43 15.80 9.07 16.07 9.80 16.2L9.67 16.7H8.5V18H10.5V16.89C11.80 16.89 12.95 16.42 13.72 15.65C14.48 14.88 14.89 13.74 14.89 12.45C14.89 11.16 14.48 10.02 13.72 9.25C12.95 8.48 11.80 8.01 10.50 8.01H8.5V6H10.5C11.80 6 12.95 6.47 13.72 7.24C14.48 8.01 14.89 9.15 14.89 10.44C14.89 11.73 14.48 12.87 13.72 13.64C12.95 14.41 11.80 14.88 10.50 14.88H8.5V13.6H10.5C11.11 13.6 11.69 13.38 12.13 12.95C12.57 12.51 12.79 11.93 12.79 11.32C12.79 10.71 12.57 10.13 12.13 9.69C11.69 9.25 11.11 9.03 10.50 9.03H8.5V7H10.5C11.80 7 12.95 7.47 13.72 8.24C14.48 9.01 14.89 10.15 14.89 11.44C14.89 12.73 14.48 13.87 13.72 14.64C12.95 15.41 11.80 15.88 10.50 15.88H8.5V16.89H10.5C11.80 16.89 12.95 16.42 13.72 15.65Z" fill="currentColor"/>
    </svg>
);

const PaypalLogo = () => (
    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-8 h-8 text-blue-800">
        <path fillRule="evenodd" clipRule="evenodd" d="M3.73 5.4C4.19 5.25 4.69 5.25 5.20 5.25H8.75C9.62 5.25 10.43 5.61 11.02 6.27C11.60 6.93 11.90 7.82 11.86 8.75V8.75C11.86 9.68 11.60 10.57 11.02 11.23C10.43 11.89 9.62 12.25 8.75 12.25H6.18C5.87 12.25 5.57 12.38 5.35 12.6C5.13 12.82 5.00 13.12 5.00 13.43V18.75C5.00 19.34 5.46 19.80 6.05 19.80C6.64 19.80 7.10 19.34 7.10 18.75V13.84H8.75C10.63 13.84 12.30 13.06 13.56 11.6C14.82 10.14 15.49 8.21 15.49 6.25C15.49 4.29 14.82 2.36 13.56 0.9C12.30 0.12 10.63 0 8.75 0H5.20C4.19 0 3.20 0.44 2.57 1.25C1.94 2.06 1.76 3.09 2.07 4.09L3.73 5.4ZM18.80 5.25H21.25C21.75 5.25 22.25 5.44 22.62 5.81C22.99 6.18 23.18 6.68 23.18 7.18V16.82C23.18 17.32 22.99 17.82 22.62 18.19C22.25 18.56 21.75 18.75 21.25 18.75H18.80C18.20 18.75 17.75 18.30 17.75 17.7V6.3C17.75 5.70 18.20 5.25 18.80 5.25Z" fill="currentColor"/>
    </svg>
);

const MastercardLogo = () => (
    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-8 h-8">
        <circle cx="9" cy="12" r="7" fill="#EB001B"/>
        <circle cx="15" cy="12" r="7" fill="#FF5F00" opacity="0.8"/>
        <path d="M12 19C15.866 19 19 15.866 19 12C19 8.13401 15.866 5 12 5C8.13401 5 5 8.13401 5 12C5 15.866 8.13401 19 12 19Z" fill="#F79E1B" opacity="0.3"/>
    </svg>
);

const WesternUnionLogo = () => (
    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-8 h-8 text-yellow-600">
        <path fillRule="evenodd" clipRule="evenodd" d="M21 12L16 7V11H4V13H16V17L21 12Z" fill="currentColor"/>
        <path d="M4 4H20V6H4V4Z" fill="currentColor" opacity="0.5"/>
        <path d="M4 18H20V20H4V18Z" fill="currentColor" opacity="0.5"/>
    </svg>
);

const EthereumLogo = () => (
    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" className="w-8 h-8 text-purple-600">
        <path d="M12 1L5 12L12 16L19 12L12 1ZM12 18V23L19 13L12 18Z" fill="currentColor"/>
    </svg>
);


// --- COMPOSANT THREE.JS SCENE ---
const ThreeScene = React.memo(({ currentPage }) => {
    const mountRef = useRef(null);
    const sceneRef = useRef(null);
    const cameraRef = useRef(null);
    const rendererRef = useRef(null);
    const controlsRef = useRef(null);
    const animationIdRef = useRef(null);
    const mainElementsRef = useRef([]);

    const create3DObject = useCallback((width, height, color, position) => {
        const geometry = new THREE.BoxGeometry(width, height, 0.15);
        const material = new THREE.MeshStandardMaterial({ 
            color: color, 
            metalness: 0.2, 
            roughness: 0.5 
        });
        const mesh = new THREE.Mesh(geometry, material);
        mesh.position.set(position.x, position.y, position.z);
        mesh.castShadow = true;
        mesh.receiveShadow = true;
        return mesh;
    }, []);

    useEffect(() => {
        if (currentPage !== 'dashboard') return;

        // 1. SC√àNE
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf0f8ff);
        sceneRef.current = scene;

        // 2. CAM√âRA
        const camera = new THREE.PerspectiveCamera(75, mountRef.current.clientWidth / mountRef.current.clientHeight, 0.1, 1000);
        camera.position.set(0, 3, 5);
        cameraRef.current = camera;

        // 3. RENDU
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(mountRef.current.clientWidth, mountRef.current.clientHeight);
        renderer.shadowMap.enabled = true;
        mountRef.current.appendChild(renderer.domElement);
        rendererRef.current = renderer;

        // 4. CONTR√îLES
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.screenSpacePanning = false;
        controls.maxPolarAngle = Math.PI / 2;
        controls.minDistance = 3;
        controls.maxDistance = 10;
        controlsRef.current = controls;
        
        // 5. √âCLAIRAGE
        scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
        directionalLight.position.set(5, 10, 7);
        directionalLight.castShadow = true;
        scene.add(directionalLight);

        // 6. CR√âATION DES OBJETS 3D (Simples placeholders)
        const elements = [];

        // Solde (Bleu Ciel) - HAUT GAUCHE
        const balanceMesh = create3DObject(4, 3, 0x87CEEB, { x: -2, y: 1.5, z: 0 }); 
        scene.add(balanceMesh);
        elements.push(balanceMesh);

        // Titulaire (Blanc) - Positionn√© au-dessus du Solde
        const holderMesh = create3DObject(3, 1, 0xFFFFFF, { x: -3, y: 3.5, z: -1 }); 
        scene.add(holderMesh);
        elements.push(holderMesh);
        
        // --- Emplacements en bas (y=-2) ---

        // Historique des transactions (Gris Clair) - BAS GAUCHE
        const historyMesh = create3DObject(5, 2.5, 0xE0E0E0, { x: -4, y: -2, z: 0 }); 
        scene.add(historyMesh);
        elements.push(historyMesh);

        // Logos Partenaires (Gris Fonc√©) - BAS MILIEU
        const logosMesh = create3DObject(3, 2.5, 0x90A4AE, { x: 1, y: -2, z: 0 });
        scene.add(logosMesh);
        elements.push(logosMesh);

        // Support/Contact (Orange Clair) - BAS DROITE
        const contactMesh = create3DObject(2, 2.5, 0xFFCC80, { x: 5.5, y: -2, z: 0.5 });
        scene.add(contactMesh);
        elements.push(contactMesh);

        // --- √âl√©ments du Menu ---

        // Menu : Virement (Bleu Profond) - HAUT DROITE (l√©g√®rement ajust√©)
        const transferMesh = create3DObject(2.5, 1.5, 0x0076A8, { x: 3, y: 2, z: 0 });
        scene.add(transferMesh);
        elements.push(transferMesh);

        // Menu : Relev√© de Compte (Blanc) - HAUT DROITE (l√©g√®rement ajust√©)
        const statementMesh = create3DObject(2.5, 1.5, 0xFFFFFF, { x: 4, y: 0, z: -1 });
        scene.add(statementMesh);
        elements.push(statementMesh);
        
        mainElementsRef.current = elements;

        // Sol (optionnel)
        const floorGeometry = new THREE.PlaneGeometry(20, 20);
        const floorMaterial = new THREE.MeshStandardMaterial({ color: 0xe0f7fa });
        const floor = new THREE.Mesh(floorGeometry, floorMaterial);
        floor.rotation.x = -Math.PI / 2;
        floor.receiveShadow = true;
        scene.add(floor);


        // 7. FONCTION D'ANIMATION
        const animate = () => {
            animationIdRef.current = requestAnimationFrame(animate);
            controls.update();

            // Rotation lente des √©l√©ments 3D pour l'effet "Dashboard flottant"
            mainElementsRef.current.forEach(element => {
                element.rotation.y += 0.005;
            });

            renderer.render(scene, camera);
        };

        // 8. GESTION DU REDIMENSIONNEMENT
        const handleResize = () => {
            if (mountRef.current && rendererRef.current && cameraRef.current) {
                cameraRef.current.aspect = mountRef.current.clientWidth / mountRef.current.clientHeight;
                cameraRef.current.updateProjectionMatrix();
                rendererRef.current.setSize(mountRef.current.clientWidth, mountRef.current.clientHeight);
            }
        };

        window.addEventListener('resize', handleResize, false);
        animate();

        // 9. NETTOYAGE (Cleanup function de React)
        return () => {
            if (animationIdRef.current) cancelAnimationFrame(animationIdRef.current);
            if (controls) controls.dispose();
            if (renderer) renderer.dispose();
            window.removeEventListener('resize', handleResize);
            if (mountRef.current && renderer.domElement) {
                mountRef.current.removeChild(renderer.domElement);
            }
        };

    }, [currentPage, create3DObject]);

    return (
        <div 
            ref={mountRef} 
            id="canvas-container" 
            className="absolute top-0 left-0 w-full h-full z-10"
        />
    );
});


// --- COMPOSANT PAGE DE CONNEXION ---
const LoginPage = ({ onLogin }) => {
    // Les valeurs initiales sont les identifiants requis pour faciliter le test
    const [login, setLogin] = useState(REQUIRED_LOGIN);
    const [password, setPassword] = useState(REQUIRED_PASSWORD);
    const [error, setError] = useState('');

    const handleSubmit = (e) => {
        e.preventDefault();
        if (login === REQUIRED_LOGIN && password === REQUIRED_PASSWORD) {
            setError('');
            onLogin();
        } else {
            setError('Identifiant ou mot de passe incorrect. Veuillez r√©essayer.');
        }
    };

    return (
        <div id="login-page" className="bg-white p-6 sm:p-10 rounded-xl shadow-2xl w-11/12 max-w-sm md:max-w-md lg:max-w-lg border-t-8 border-sky-400 z-30 pointer-events-auto">
            <div className="flex flex-col items-center mb-6">
                <h1 className="text-3xl font-bold text-sky-500">Barclays</h1>
            </div>
            
            <form onSubmit={handleSubmit}>
                <div className="mb-4">
                    <label htmlFor="login" className="block text-sm font-medium text-gray-700 mb-1">Identifiant (Login):</label>
                    <input type="text" id="login" name="login" value={login} onChange={(e) => setLogin(e.target.value)} required
                           className="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition"/>
                </div>
                <div className="mb-6">
                    <label htmlFor="password" className="block text-sm font-medium text-gray-700 mb-1">Mot de passe:</label>
                    <input type="password" id="password" name="password" value={password} onChange={(e) => setPassword(e.target.value)} required
                           className="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition"/>
                </div>
                
                <button type="submit" className="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                    SE CONNECTER
                </button>
            </form>
            <p id="error-message" className="text-red-500 text-center mt-4">{error}</p>
        </div>
    );
};

// --- NOUVEAU: COMPOSANT MODALE PERSONNALIS√âE (Remplace alert/prompt) ---
const CustomModal = ({ isOpen, onClose, title, children }) => {
    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 pointer-events-auto" onClick={onClose}>
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 sm:p-8 transform transition-all duration-300 scale-100" onClick={(e) => e.stopPropagation()}>
                <div className="flex justify-between items-start mb-4 border-b pb-3">
                    <h3 className="text-xl font-bold text-sky-800 flex items-center">
                        {title}
                    </h3>
                    <button onClick={onClose} className="text-gray-400 hover:text-gray-600 transition">
                        <X className="w-6 h-6"/>
                    </button>
                </div>
                {children}
            </div>
        </div>
    );
};

// --- COMPOSANT MODALE DE NOTIFICATION ---
const NotificationModal = ({ isOpen, onClose, notifications }) => {
    if (!isOpen) return null;

    // Affiche uniquement les 10 derni√®res notifications pour l'exemple
    const displayNotifications = notifications.slice(0, 10);
    
    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 pointer-events-auto" onClick={onClose}>
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 sm:p-8 transform transition-all duration-300 scale-100" onClick={(e) => e.stopPropagation()}>
                <div className="flex justify-between items-start mb-4 border-b pb-3">
                    <h3 className="text-2xl font-bold text-sky-800 flex items-center">
                        <Bell className="w-6 h-6 mr-3 text-yellow-500"/> Notifications ({notifications.length})
                    </h3>
                    <button onClick={onClose} className="text-gray-400 hover:text-gray-600 transition">
                        <X className="w-6 h-6"/>
                    </button>
                </div>
                
                <div className="max-h-[70vh] overflow-y-auto space-y-3">
                    {displayNotifications.length > 0 ? (
                        displayNotifications.map((notif) => (
                            <div key={notif.id} className={`p-4 rounded-lg shadow-md border ${notif.isRead ? 'bg-gray-50 border-gray-200' : 'bg-yellow-50 border-yellow-300'}`}>
                                <p className="text-sm text-gray-500 font-medium mb-1">{notif.date}</p>
                                <h4 className={`font-bold ${notif.isRead ? 'text-gray-800' : 'text-sky-800'}`}>{notif.title}</h4>
                                {/* Utilisation de max-h-32 et overflow-y-auto pour le d√©filement du message */}
                                <div className="text-sm text-gray-700 mt-2 whitespace-pre-line max-h-32 overflow-y-auto pr-2">
                                    {notif.message.trim().split('\n').map((line, index) => (
                                        <p key={index} className="mb-1 last:mb-0">{line.trim()}</p>
                                    ))}
                                </div>
                            </div>
                        ))
                    ) : (
                        <div className="text-center py-10 text-gray-500">
                            Aucune nouvelle notification.
                        </div>
                    )}
                </div>
                
                <button onClick={onClose} className="mt-6 w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 rounded-lg transition duration-200">
                    Fermer
                </button>
            </div>
        </div>
    );
};


// --- COMPOSANTS DES OVERLAYS (r√©utilis√©s par Dashboard) ---

// Historique des transactions
const TransactionHistoryOverlay = ({ transactions }) => {
    const cardClasses = 'p-4 sm:p-6 rounded-xl shadow-2xl backdrop-blur-sm w-full md:w-80 lg:w-96 flex-shrink-0'; 
    
    // N'afficher que les 5 derni√®res transactions
    const latestTransactions = transactions.slice(0, 5);

    return (
        <div id="history-overlay" 
             className={cardClasses}
             style={{ 
                backgroundColor: 'rgba(224, 224, 224, 0.7)', // Gris Clair transparent
                pointerEvents: 'auto' 
             }}
        >
            <h3 className="text-xl font-bold text-gray-800 mb-3 flex items-center"><Clock className="w-5 h-5 mr-2 text-sky-600"/> Historique R√©cent</h3>
            
            <div className="space-y-3 max-h-48 overflow-y-auto">
                {latestTransactions.map((transaction) => (
                    <div key={transaction.id} className="flex justify-between items-center bg-white/70 p-3 rounded-lg shadow-md">
                        <div>
                            <p className="text-sm font-medium text-gray-700">{transaction.description}</p>
                            <p className="text-xs text-gray-500 mt-0.5">{transaction.date}</p>
                        </div>
                        <p className={`text-lg font-bold ${transaction.type === 'debit' ? 'text-red-600' : 'text-green-600'}`}>
                            {formatAmount(transaction.amount, transaction.type)}
                        </p>
                    </div>
                ))}
                {latestTransactions.length === 0 && (
                    <p className="text-center text-gray-500 pt-3">Aucune transaction r√©cente.</p>
                )}
                <div className="text-center pt-2">
                    <button className="text-sm font-semibold text-sky-600 hover:text-sky-800 transition">Voir toutes les op√©rations ‚Üí</button>
                </div>
            </div>
        </div>
    );
};


// Logos Partenaires
const PartnerLogosOverlay = ({ handleMastercardDeposit }) => {
    const logos = [
        { name: 'Crypto', icon: <BitcoinLogo />, isInteractive: false },
        { name: 'PayPal', icon: <PaypalLogo />, isInteractive: false },
        { name: 'Mastercard', icon: <MastercardLogo />, isInteractive: true, action: handleMastercardDeposit },
        { name: 'W. Union', icon: <WesternUnionLogo />, isInteractive: false },
        { name: 'ETH B2B', icon: <EthereumLogo />, isInteractive: false },
    ];

    const cardClasses = 'p-4 sm:p-6 rounded-xl shadow-2xl backdrop-blur-sm w-full md:w-60 lg:w-64 flex-shrink-0';
    
    return (
        <div id="partner-logos-overlay" 
             className={cardClasses} 
             style={{ 
                backgroundColor: 'rgba(144, 164, 174, 0.7)', // Gris Ardoise transparent
                pointerEvents: 'auto'
             }}
        >
            <h3 className="text-xl font-bold text-white mb-4 flex items-center"><Users className="w-5 h-5 mr-2 text-white"/> Transferts & Partenaires</h3>
            
            <div id="partner-logos" className="grid grid-cols-3 gap-3 sm:grid-cols-3 lg:grid-cols-2">
                {logos.map((logo, index) => (
                    <button 
                        key={index} 
                        onClick={logo.isInteractive ? logo.action : undefined}
                        // Style conditionnel
                        className={`
                            flex flex-col items-center p-2 bg-white/80 rounded-lg shadow-inner transition duration-200
                            ${logo.isInteractive 
                                ? 'cursor-pointer hover:bg-white ring-2 ring-offset-1 ring-sky-500 transform scale-105' 
                                : 'cursor-default opacity-80'
                            }
                        `}
                        disabled={!logo.isInteractive}
                    >
                        {logo.icon}
                        <span className="text-xs font-semibold text-gray-700 mt-1 text-center">{logo.name}</span>
                    </button>
                ))}
            </div>
        </div>
    );
};


// Options de contact et de support
const SupportContactOverlay = () => {
    // D√©finition des ic√¥nes Lucide-React
    const PhoneLogo = () => <DollarSign className="w-5 h-5 text-sky-600"/>
    const ChatLogo = () => <MessageSquare className="w-5 h-5 text-sky-600"/>
    const LockLogo = () => <Shield className="w-5 h-5 text-red-600"/>
    
    const options = [
        // Utilisation des ic√¥nes comme composants React
        { name: 'Appeler le Support', icon: <PhoneLogo />, action: () => console.log("Appel au support simul√© : 0800 555 1234") },
        { name: 'Chat en Direct', icon: <ChatLogo />, action: () => console.log("Lancement du chat en direct simul√©") },
        { name: 'Bloquer la Carte', icon: <LockLogo />, action: () => console.log("Proc√©dure de blocage de carte d'urgence simul√©e") },
    ];

    return (
        <div id="support-contact-overlay" 
             className="p-4 sm:p-6 rounded-xl shadow-2xl backdrop-blur-sm w-full md:w-60 lg:w-64 flex-shrink-0" 
             style={{ 
                backgroundColor: 'rgba(255, 255, 255, 0.8)', // Blanc tr√®s l√©ger
                pointerEvents: 'auto' 
             }}
        >
            <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center"><LifeBuoy className="w-5 h-5 mr-2 text-sky-600"/> Aide & Support</h3>
            
            <div id="support-options" className="space-y-3">
                {options.map((option, index) => (
                    <button key={index} onClick={option.action}
                         className="flex items-center w-full p-3 bg-white hover:bg-sky-50 transition duration-200 rounded-lg shadow-md">
                        {/* Assurez-vous que option.icon est un √©l√©ment React valide */}
                        {option.icon}
                        <span className={`text-sm font-semibold ml-3 ${option.name.includes('Bloquer') ? 'text-red-600' : 'text-gray-700'}`}>
                            {option.name}
                        </span>
                    </button>
                ))}
            </div>
        </div>
    );
};


// --- COMPOSANT TABLEAU DE BORD (DASHBOARD) ---
const Dashboard = ({ onLogout, navigate, currentBalance, handleMastercardDeposit, transactions, notifications, handleOpenNotification }) => { 
    const [isMenuOpen, setIsMenuOpen] = useState(false);
    const [isServicesOpen, setIsServicesOpen] = useState(false);
    
    // Calculer le nombre de notifications non lues
    const unreadCount = notifications.filter(n => !n.isRead).length;

    // Solde format√© pour l'affichage
    const formattedBalance = formatBalance(currentBalance); 
    
    const toggleMenu = useCallback((e) => {
        if (e && (e.target.closest('.overlay-button') || e.target.closest('.dropdown-menu'))) {
            return;
        }
        setIsMenuOpen(false);
    }, []);

    useEffect(() => {
        document.addEventListener('click', toggleMenu);
        return () => {
            document.removeEventListener('click', toggleMenu);
        };
    }, [toggleMenu]);
    
    const handleMenuItemClick = (page) => {
        navigate(page);
        setIsMenuOpen(false); // Ferme le menu apr√®s la navigation
    };


    return (
        <>
            {/* Sc√®ne 3D en arri√®re-plan */}
            <ThreeScene currentPage="dashboard" />

            {/* Overlay 2D pour les donn√©es cl√©s */}
            <div id="data-overlay" className="absolute top-0 left-0 w-full h-full z-20 pointer-events-none">
                
                {/* Titulaire du Compte */}
                <div className="absolute top-20 left-4 md:top-20 md:left-6 p-4 rounded-lg shadow-xl w-4/5 max-w-xs"
                     style={{ 
                        backgroundColor: 'rgba(255, 255, 255, 0.9)', 
                        pointerEvents: 'none'
                     }}
                >
                    <p className="text-sm sm:text-lg font-medium text-gray-700">Bienvenue Mr</p>
                    <p className="text-lg sm:text-xl font-bold text-sky-800 mt-1">{ACCOUNT_HOLDER_NAME}</p>
                </div>

                {/* Solde Actuel */}
                <div className="absolute top-[11rem] left-4 md:top-[12rem] md:left-6 p-6 rounded-xl shadow-2xl backdrop-blur-sm w-11/12 max-w-xs md:max-w-sm"
                     style={{ 
                        backgroundColor: 'rgba(135, 206, 235, 0.7)',
                        pointerEvents: 'none'
                     }}
                >
                    <p className="text-base sm:text-xl font-semibold text-white opacity-90">Solde Actuel</p>
                    <p className="text-3xl sm:text-5xl font-extrabold text-white mt-2">{formattedBalance}</p>
                </div>
            </div>

            {/* Conteneur Flex pour les 3 blocs du bas : HISTORIQUE | PARTENAIRES | SUPPORT */}
            <div id="bottom-bar-container" className="absolute bottom-0 left-0 right-0 p-4 z-30 pointer-events-none flex flex-col md:flex-row justify-center md:justify-end items-center md:items-start gap-4 md:gap-6">
                
                <div className="md:order-1 pointer-events-auto">
                    <TransactionHistoryOverlay transactions={transactions} />
                </div>
                
                {/* PARTENAIRES : Rendu interactif pour Mastercard */}
                <div className="md:order-2"> 
                    <PartnerLogosOverlay 
                        handleMastercardDeposit={handleMastercardDeposit}
                    />
                </div>
                
                <div className="md:order-3 pointer-events-auto">
                    <SupportContactOverlay />
                </div>
                
            </div>


            {/* Overlay 2D pour le Header et les boutons interactifs */}
            <div id="dashboard-overlay" className="absolute top-0 left-0 w-full h-full z-30 pointer-events-none">
                {/* Header/Menu */}
                <div className="flex justify-between items-start p-3 sm:p-4 bg-sky-800/80 backdrop-blur-sm shadow-lg w-full pointer-events-auto">
                    <div className="text-white text-base sm:text-lg font-semibold flex items-center">Barclays</div>
                    
                    <div className="flex space-x-2 sm:space-x-3">
                        {/* Bouton de Notification - G√©r√© pour le clic uniquement */}
                        <div className="relative">
                            <button 
                                id="notification-btn" 
                                onClick={handleOpenNotification} 
                                className="bg-yellow-400 hover:bg-yellow-500 text-gray-800 p-2 text-sm rounded-full shadow-lg transition duration-200 flex items-center overlay-button"
                            >
                                <Bell className="w-5 h-5" /> <span className="hidden sm:inline ml-1">Notifications</span>
                            </button>
                            {/* Badge non lu - S'affiche uniquement si non lu */}
                            {unreadCount > 0 && (
                                <span className="absolute top-0 right-0 block h-5 w-5 rounded-full ring-2 ring-white bg-red-500 transform translate-x-1 -translate-y-1 text-xs text-white font-bold flex items-center justify-center">
                                    {unreadCount}
                                </span>
                            )}
                        </div>
                        
                        {/* Menu D√©roulant */}
                        <div className="relative">
                            <button onClick={(e) => { e.stopPropagation(); setIsMenuOpen(!isMenuOpen); }} className="bg-white text-sky-500 p-2 text-sm rounded-full hover:bg-gray-100 flex items-center shadow-lg overlay-button">
                                <Menu className="w-5 h-5" /> <span className="hidden sm:inline ml-1">Menu</span>
                            </button>
                            
                            <div className={`dropdown-menu absolute right-0 mt-2 w-48 sm:w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 ${isMenuOpen ? '' : 'hidden'}`}>
                                <a href="#" onClick={() => handleMenuItemClick('transfer')} className="block px-4 py-2 text-sm text-gray-700 hover:bg-sky-500 hover:text-white rounded-t-md flex items-center"><Send className="w-4 h-4 mr-2"/> Virement</a>
                                <a href="#" onClick={() => handleMenuItemClick('statement')} className="block px-4 py-2 text-sm text-gray-700 hover:bg-sky-500 hover:text-white flex items-center"><BookOpen className="w-4 h-4 mr-2"/> Relev√© de Compte</a>
                                
                                <div className="border-t border-gray-100 my-1"></div>
                                
                                <button onClick={(e) => { e.stopPropagation(); setIsServicesOpen(!isServicesOpen); }} className="flex justify-between items-center w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <span className="font-semibold text-gray-700 flex items-center"><DollarSign className="w-4 h-4 mr-2 text-green-600"/> Nos Services</span>
                                    <ChevronDown className={`w-4 h-4 transition-transform duration-300 ${isServicesOpen ? 'rotate-180' : 'rotate-0'}`} />
                                </button>
                                
                                <div className={`${isServicesOpen ? '' : 'hidden'}`}>
                                    <a href="#" onClick={() => handleMenuItemClick('services')} className="block pl-8 pr-4 py-2 text-xs text-gray-600 hover:bg-sky-500 hover:text-white">√âpargne & Investissement</a>
                                    <a href="#" onClick={() => handleMenuItemClick('services')} className="block pl-8 pr-4 py-2 text-xs text-gray-600 hover:bg-sky-500 hover:text-white">Cr√©dits & Assurances</a>
                                </div>

                                <div className="border-t border-gray-100 mt-1"></div>
                                <a href="#" onClick={onLogout} className="block px-4 py-2 text-sm text-red-500 hover:bg-red-500 hover:text-white rounded-b-md flex items-center"><LogOut className="w-4 h-4 mr-2"/> D√©connexion</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            {/* Modale de Notification */}
            {/* Elle est maintenant g√©r√©e par le composant App principal pour acc√©der √† toutes les notifications */}
        </>
    );
};


// --- COMPOSANT PAGE DE VIREMENT ---
const TransferPage = ({ navigate, currentBalance, handleTransfer }) => {
    // √âtat pour les champs de saisie libre
    const [amount, setAmount] = useState('');
    const [recipient, setRecipient] = useState(''); // Nom du b√©n√©ficiaire
    const [iban, setIban] = useState(''); // IBAN
    const [motive, setMotive] = useState(''); // Motif
    const [isAlertOpen, setIsAlertOpen] = useState(false); // √âtat pour la modale custom
    const [alertMessage, setAlertMessage] = useState('');
    const [alertTitle, setAlertTitle] = useState('');
    
    // Solde format√© pour l'affichage
    const formattedBalance = formatBalance(currentBalance); 
    
    // Fonction pour remplacer alert()
    const showAlert = (title, message) => {
        setAlertTitle(title);
        setAlertMessage(message);
        setIsAlertOpen(true);
    };

    const handleSubmit = (e) => {
        e.preventDefault();
        
        const transferAmount = parseFloat(amount);

        // 1. V√©rification de la saisie
        if (!recipient.trim()) {
            showAlert("Erreur de Saisie", "Veuillez entrer le nom du b√©n√©ficiaire.");
            return;
        }
        if (iban.trim().length < 15) {
            showAlert("Erreur de Saisie", "Veuillez entrer un IBAN valide (min 15 caract√®res).");
            return;
        }
        if (isNaN(transferAmount) || transferAmount <= 0) {
            showAlert("Erreur de Saisie", "Veuillez entrer un montant valide (> 0).");
            return;
        }
        
        // 2. D√©clenchement de la fonction de transfert dans le composant parent (App)
        const success = handleTransfer({
            amount: transferAmount,
            recipient: recipient,
            iban: iban,
            motive: motive,
            type: 'debit'
        });

        if (success) {
             showAlert(
                 "Virement R√©ussi", 
                 `Virement de ${formatAmount(transferAmount, 'debit')} effectu√©.\n\n√Ä : ${recipient}\nIBAN : ${iban}\nMotif : ${motive || 'Non sp√©cifi√©'}\n\nVotre nouveau solde est de : ${formatBalance(currentBalance - transferAmount)}`
             );
            
            // R√©initialisation des champs apr√®s simulation
            setAmount('');
            setRecipient('');
            setIban('');
            setMotive('');
        } else {
            showAlert("√âchec du Virement", "Votre solde est insuffisant pour effectuer cette op√©ration.");
        }
    };

    return (
        <div className="absolute top-0 left-0 w-full h-full p-4 sm:p-6 md:p-12 bg-gray-50 z-30 pointer-events-auto overflow-y-auto">
            <button onClick={() => navigate('dashboard')} className="bg-sky-500 text-white p-2 rounded-lg mb-6 flex items-center hover:bg-sky-600 shadow-lg transition duration-200">
                <ChevronLeft className="w-5 h-5 mr-2"/> Retour au Tableau de Bord
            </button>

            <div className="max-w-xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-2xl border-t-4 border-sky-400">
                <h2 className="text-3xl font-extrabold text-sky-800 mb-6">Effectuer un Virement</h2>
                {/* Affichage dynamique du solde */}
                <p className="text-gray-600 mb-6">Solde disponible: <span className={`font-bold text-lg ${currentBalance < 0 ? 'text-red-600' : 'text-green-600'}`}>{formattedBalance}</span></p>

                <form onSubmit={handleSubmit} className="space-y-6">
                    {/* CHAMP NOM (B√©n√©ficiaire) - Saisie libre */}
                    <div>
                        <label htmlFor="recipient" className="block text-sm font-medium text-gray-700 mb-1">Nom du B√©n√©ficiaire :</label>
                        <input type="text" id="recipient" value={recipient} onChange={(e) => setRecipient(e.target.value)} required
                               placeholder="Nom et Pr√©nom (ou D√©nomination sociale)"
                               className="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition"/>
                    </div>

                    {/* CHAMP IBAN - Saisie libre */}
                    <div>
                        <label htmlFor="iban" className="block text-sm font-medium text-gray-700 mb-1">IBAN :</label>
                        <input type="text" id="iban" value={iban} 
                               onChange={(e) => setIban(e.target.value.toUpperCase().replace(/[^A-Z0-9\s]/g, ''))} 
                               required 
                               minLength="15"
                               placeholder="Ex: FR76 XXXXXXXXXXX..."
                               className="w-full p-3 border border-red-400 rounded-lg text-lg focus:ring-red-500 focus:border-red-500 transition text-gray-800"/>
                        <p className="text-xs text-red-600 mt-1">Veuillez saisir l'IBAN complet de votre b√©n√©ficiaire.</p>
                    </div>
                    
                    {/* CHAMP MOTIF DE VIREMENT */}
                    <div>
                        <label htmlFor="motive" className="block text-sm font-medium text-gray-700 mb-1">Motif du Virement (Optionnel) :</label>
                        <input type="text" id="motive" value={motive} onChange={(e) => setMotive(e.target.value)}
                               placeholder="Ex: Loyer, Cadeau, Remboursement..."
                               className="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition"/>
                    </div>


                    {/* CHAMP MONTANT */}
                    <div>
                        <label htmlFor="amount" className="block text-sm font-medium text-gray-700 mb-1">Montant (‚Ç¨) :</label>
                        <input type="number" id="amount" value={amount} onChange={(e) => setAmount(e.target.value)} required min="1" step="0.01"
                               placeholder="Ex: 500.00"
                               className="w-full p-3 border border-gray-300 rounded-lg text-xl focus:ring-sky-500 focus:border-sky-500 transition"/>
                    </div>
                    
                    <button type="submit" className="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-md flex items-center justify-center">
                        <Send className="w-5 h-5 mr-2"/> CONFIRMER LE VIREMENT
                    </button>
                </form>
            </div>
            {/* Modale Custom pour les alertes */}
            <CustomModal isOpen={isAlertOpen} onClose={() => setIsAlertOpen(false)} title={alertTitle}>
                <p className="text-gray-700 whitespace-pre-line">{alertMessage}</p>
                <button onClick={() => setIsAlertOpen(false)} className="mt-4 w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 rounded-lg transition duration-200">
                    OK
                </button>
            </CustomModal>
        </div>
    );
};


// --- COMPOSANT PAGE RELEV√â DE COMPTE ---
const StatementPage = ({ navigate }) => {
    const [year, setYear] = useState('2025');
    const statements = [
        { month: 'Novembre 2025', status: 'Disponible', action: () => console.log('T√©l√©chargement Novembre 2025') },
        { month: 'Octobre 2025', status: 'Disponible', action: () => console.log('T√©l√©chargement Octobre 2025') },
        { month: 'Septembre 2025', status: 'Disponible', action: () => console.log('T√©l√©chargement Septembre 2025') },
        { month: 'Ao√ªt 2025', status: 'Disponible', action: () => console.log('T√©l√©chargement Ao√ªt 2025') },
        { month: 'Juillet 2025', status: 'Disponible', action: () => console.log('T√©l√©chargement Juillet 2025') },
    ];
    
    return (
        <div className="absolute top-0 left-0 w-full h-full p-4 sm:p-6 md:p-12 bg-gray-50 z-30 pointer-events-auto overflow-y-auto">
            <button onClick={() => navigate('dashboard')} className="bg-sky-500 text-white p-2 rounded-lg mb-6 flex items-center hover:bg-sky-600 shadow-lg transition duration-200">
                <ChevronLeft className="w-5 h-5 mr-2"/> Retour au Tableau de Bord
            </button>

            <div className="max-w-xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-2xl border-t-4 border-sky-400">
                <h2 className="text-3xl font-extrabold text-sky-800 mb-6">Relev√©s de Compte</h2>
                <p className="text-gray-600 mb-6">T√©l√©chargez vos relev√©s au format PDF.</p>

                <div className="mb-6">
                    <label htmlFor="year-select" className="block text-sm font-medium text-gray-700 mb-1">S√©lectionner l'Ann√©e :</label>
                    <select id="year-select" value={year} onChange={(e) => setYear(e.target.value)}
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500 transition appearance-none bg-white">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                    </select>
                </div>

                <div className="space-y-4">
                    {statements.map((statement, index) => (
                        <div key={index} className="flex justify-between items-center p-4 bg-gray-50 rounded-lg shadow-sm">
                            <p className="font-semibold text-gray-700">{statement.month} ({year})</p>
                            <button onClick={statement.action} 
                                    className="px-4 py-2 bg-green-500 text-white text-sm font-medium rounded-lg hover:bg-green-600 transition shadow-md">
                                T√©l√©charger PDF
                            </button>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
};


// --- COMPOSANT PAGE DES SERVICES ---
const ServicesPage = ({ navigate }) => {
    const serviceCards = [
        { id: 'crypto', title: 'üìà √âpargne & Investissement en Crypto', text: "Explorez le monde de la cryptomonnaie avec des outils d'investissement s√©curis√©s et r√©glement√©s par Barclays. Commencez √† diversifier votre portefeuille d√®s aujourd'hui.", color: 'border-yellow-500', linkText: "Commencer l'investissement ‚Üí" },
        { id: 'credit', title: 'üè† Cr√©dits & Pr√™ts', text: 'Financement pour tous vos projets : immobilier, automobile ou personnel. Demandez un pr√™t en ligne avec des taux comp√©titifs, une r√©ponse rapide et un accompagnement personnalis√©.', color: 'border-sky-500', linkText: 'Simuler un pr√™t ‚Üí' },
        { id: 'assurance', title: 'üõ°Ô∏è Assurances', text: 'Prot√©gez ce qui compte le plus. Nous proposons des assurances habitation, automobile et sant√© sur mesure pour vous offrir une tranquillit√© d‚Äôesprit totale.', color: 'border-green-500', linkText: "Voir nos offres d'assurance ‚Üí" },
    ];

    return (
        <div id="services-page" className="absolute top-0 left-0 w-full h-full p-4 sm:p-6 md:p-12 bg-gray-50 z-30 pointer-events-auto overflow-y-auto">
            <button onClick={() => navigate('dashboard')} className="bg-sky-500 text-white p-2 rounded-lg mb-6 flex items-center hover:bg-sky-600 shadow-lg transition duration-200">
                <ChevronLeft className="w-5 h-5 mr-2"/> Retour au Tableau de Bord
            </button>

            <h2 className="text-3xl sm:text-4xl font-extrabold text-sky-800 mb-8">D√©couvrez nos services financiers</h2>
            
            <div className="space-y-6 max-w-4xl mx-auto">
                {serviceCards.map(card => (
                    <div key={card.id} id={`card-${card.id}`} className={`bg-white p-6 rounded-xl shadow-lg border-l-4 ${card.color} transition duration-300 hover:shadow-xl`}>
                        <h3 className="text-xl sm:text-2xl font-bold text-gray-800 mb-2 flex items-center">{card.title}</h3>
                        <p className="text-sm sm:text-base text-gray-600">{card.text}</p>
                        <a href="#" onClick={() => console.log(`Lien vers la page ${card.title} simul√©`)} className="text-sky-500 hover:text-sky-700 font-semibold mt-3 block">{card.linkText}</a>
                    </div>
                ))}
            </div>
        </div>
    );
};


// --- COMPOSANT MODALE DE D√âP√îT MASTERCARD ---
const MastercardDepositModal = ({ isOpen, onClose, onConfirmDeposit, currentBalance }) => {
    const [amount, setAmount] = useState('');
    const [error, setError] = useState('');

    const formattedBalance = formatBalance(currentBalance);

    const handleDepositSubmit = (e) => {
        e.preventDefault();
        setError('');

        const depositAmount = parseFloat(amount);
        
        if (isNaN(depositAmount) || depositAmount <= 0) {
            setError('Veuillez entrer un montant de d√©p√¥t valide (> 0).');
            return;
        }

        // Simuler le d√©p√¥t
        onConfirmDeposit(depositAmount);
        
        // Fermer la modale et r√©initialiser
        onClose();
        setAmount('');
    };

    return (
        <CustomModal isOpen={isOpen} onClose={onClose} title={<span className="flex items-center"><PlusCircle className="w-5 h-5 mr-2 text-green-500"/> D√©p√¥t Rapide Mastercard</span>}>
            <p className="text-sm text-gray-600 mb-4">Simulez un d√©p√¥t imm√©diat par virement Mastercard.</p>
            
            <p className="text-gray-600 mb-4">Solde actuel : <span className="font-bold text-green-600">{formattedBalance}</span></p>

            <form onSubmit={handleDepositSubmit} className="space-y-4">
                <div>
                    <label htmlFor="deposit-amount" className="block text-sm font-medium text-gray-700 mb-1">Montant √† D√©poser (‚Ç¨) :</label>
                    <input 
                        type="number" 
                        id="deposit-amount" 
                        value={amount} 
                        onChange={(e) => setAmount(e.target.value)} 
                        required 
                        min="1" 
                        step="0.01"
                        placeholder="Ex: 1000.00"
                        className="w-full p-3 border border-sky-400 rounded-lg text-lg focus:ring-sky-500 focus:border-sky-500 transition"
                    />
                </div>
                
                {error && <p className="text-red-500 text-sm">{error}</p>}
                
                <button type="submit" className="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition duration-200 shadow-md flex items-center justify-center">
                    CONFIRMER LE D√âP√îT
                </button>
            </form>
        </CustomModal>
    );
};


// --- COMPOSANT PRINCIPAL (App) ---
export default function App() {
    const [currentPage, setCurrentPage] = useState('login');
    const [balance, setBalance] = useState(INITIAL_BALANCE); 
    // √âtat pour l'historique des transactions, tri√© par ID d√©croissant
    const [transactions, setTransactions] = useState(INITIAL_TRANSACTION_HISTORY.sort((a, b) => b.id - a.id)); 
    // √âtat pour toutes les notifications
    const [notifications, setNotifications] = useState([INITIAL_UNREAD_NOTIFICATION_DATA]); 
    const [isDepositModalOpen, setIsDepositModalOpen] = useState(false);
    const [isNotificationModalOpen, setIsNotificationModalOpen] = useState(false);
    const [isAlertOpen, setIsAlertOpen] = useState(false);
    const [alertMessage, setAlertMessage] = useState('');
    const [alertTitle, setAlertTitle] = useState('');

    // Fonction pour g√©n√©rer un ID unique (bas√© sur le nombre actuel de notifications/transactions)
    const generateId = () => Math.max(...transactions.map(t => t.id), ...notifications.map(n => n.id || 0), 0) + 1;

    const showAlert = (title, message) => {
        setAlertTitle(title);
        setAlertMessage(message);
        setIsAlertOpen(true);
    };

    const handleLogin = () => {
        setCurrentPage('dashboard');
    };

    const handleLogout = () => {
        setCurrentPage('login');
        setBalance(INITIAL_BALANCE); 
        setTransactions(INITIAL_TRANSACTION_HISTORY.sort((a, b) => b.id - a.id));
        setNotifications([INITIAL_UNREAD_NOTIFICATION_DATA]);
    };
    
    // Fonction de navigation unique
    const navigate = (page) => {
        setCurrentPage(page);
    };
    
    // Fonction g√©n√©rique pour ajouter une transaction et une notification
    const addTransactionAndNotification = (transactionData) => {
        const newId = generateId();
        const date = getCurrentDate();
        
        // 1. Mise √† jour du solde
        const newBalance = transactionData.type === 'debit' 
            ? balance - transactionData.amount 
            : balance + transactionData.amount;
        setBalance(newBalance);

        // 2. Cr√©ation de l'entr√©e de transaction
        const newTransaction = {
            id: newId,
            date: date,
            amount: transactionData.amount,
            type: transactionData.type,
            description: transactionData.description,
        };
        setTransactions(prev => [newTransaction, ...prev]);

        // 3. Cr√©ation de la notification
        let notificationTitle;
        let notificationMessage;
        
        if (transactionData.type === 'debit') {
            notificationTitle = "Virement Effectu√©";
            notificationMessage = `Votre virement de ${formatAmount(transactionData.amount, 'debit')} vers ${transactionData.recipient} a √©t√© ex√©cut√©.\nNouveau Solde : ${formatBalance(newBalance)}.`;
        } else { // type === 'credit'
            notificationTitle = "D√©p√¥t Re√ßu";
            notificationMessage = `Un d√©p√¥t de ${formatAmount(transactionData.amount, 'credit')} a √©t√© cr√©dit√© sur votre compte.\nMotif : ${transactionData.motive}.\nNouveau Solde : ${formatBalance(newBalance)}.`;
        }
        
        const newNotification = {
            id: newId,
            date: date,
            title: notificationTitle,
            message: notificationMessage,
            isRead: false,
        };
        setNotifications(prev => [newNotification, ...prev]);
        
        return newBalance;
    };
    
    // Fonction de gestion du virement (d√©bit)
    const handleTransfer = ({ amount, recipient, iban, motive, type }) => {
        if (amount > balance) {
            return false;
        }
        
        addTransactionAndNotification({
            amount: amount,
            type: 'debit',
            description: `Virement ${recipient} (IBAN: ${iban.slice(-4)})`,
            recipient: recipient, // Pour le message d'alerte/notification
        });
        
        return true;
    };
    
    // Fonction pour ouvrir la modale de d√©p√¥t Mastercard
    const handleMastercardDepositClick = () => {
        setIsDepositModalOpen(true);
    };

    // Fonction pour confirmer et effectuer le d√©p√¥t (cr√©dit)
    const handleConfirmDeposit = (amount) => {
        const newBalance = addTransactionAndNotification({
            amount: amount,
            type: 'credit',
            description: 'D√©p√¥t par Mastercard (Rapide)',
            motive: 'D√©p√¥t Mastercard', // Pour le message de notification
        });

        showAlert(
            "D√©p√¥t R√©ussi", 
            `Votre d√©p√¥t de ${formatAmount(amount, 'credit')} a √©t√© cr√©dit√© instantan√©ment.\n\nVotre nouveau solde est de : ${formatBalance(newBalance)}.`
        );
    };
    
    // G√®re l'ouverture de la modale de notifications et marque toutes les notifications comme lues
    const handleOpenNotification = () => {
        setIsNotificationModalOpen(true);
        // Marquer toutes les notifications comme lues lors de l'ouverture
        setNotifications(prevNotifications => 
            prevNotifications.map(n => ({ ...n, isRead: true }))
        );
    };

    const renderPage = () => {
        switch (currentPage) {
            case 'login':
                return <LoginPage onLogin={handleLogin} />;
            case 'dashboard':
                return <Dashboard 
                            onLogout={handleLogout} 
                            navigate={navigate} 
                            currentBalance={balance} 
                            handleMastercardDeposit={handleMastercardDepositClick} 
                            transactions={transactions} // Passage de l'historique
                            notifications={notifications} // Passage des notifications pour le badge
                            handleOpenNotification={handleOpenNotification} // Passage pour le bouton Bell
                        />;
            case 'transfer':
                return <TransferPage 
                            navigate={navigate} 
                            currentBalance={balance} 
                            handleTransfer={handleTransfer} // Passage de la fonction de d√©bit
                        />;
            case 'statement':
                return <StatementPage navigate={navigate} />;
            case 'services':
                return <ServicesPage navigate={navigate} />;
            default:
                return <LoginPage onLogin={handleLogin} />;
        }
    };

    return (
        <div id="app-container" className="relative w-screen h-screen flex flex-col items-center justify-center bg-white overflow-hidden font-sans">
            {renderPage()}
            
            {/* Modale de D√©p√¥t Mastercard */}
            <MastercardDepositModal
                isOpen={isDepositModalOpen}
                onClose={() => setIsDepositModalOpen(false)}
                onConfirmDeposit={handleConfirmDeposit}
                currentBalance={balance}
            />
            
            {/* Modale de Notification (Modifi√©e pour prendre l'√©tat des notifications) */}
            <NotificationModal 
                isOpen={isNotificationModalOpen} 
                onClose={() => setIsNotificationModalOpen(false)} 
                notifications={notifications}
            />
            
            {/* Modale Custom pour les messages de succ√®s/erreur au niveau global */}
            <CustomModal isOpen={isAlertOpen} onClose={() => setIsAlertOpen(false)} title={alertTitle}>
                <p className="text-gray-700 whitespace-pre-line">{alertMessage}</p>
                <button onClick={() => setIsAlertOpen(false)} className="mt-4 w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 rounded-lg transition duration-200">
                    OK
                </button>
            </CustomModal>
        </div>
    );
}
